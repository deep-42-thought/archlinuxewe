#!/bin/bash

if [ $# -ne 1 ]
then
  err=0
  for pkg in "$@"
  do
    $0 "${pkg}"
    cErr=$?
    [ ${cErr} -gt ${err} ] && err=${cErr}
  done
  exit ${err}
fi

paket="${1%/}"

cd "$(dirname "$(readlink -f "$0")")"
[ -r "${paket}/PKGBUILD" ] || exit 1
eval $(./checkVersions -m "${paket}")
if [ "${remVer}" == "${pkgver}" ]
then
  exit 0
fi

cd "${paket}"

sed 's|pkgver=.*$|pkgver='"${remVer}"'|;
  s|pkgrel=.*$|pkgrel=1|;
  s@^\s*\(sha[[:digit:]]\+sums\|md5sums\)=@sha512sums=@
' -i PKGBUILD

sed '
  :begin;
    $!N;
    s@^sha512sums=\([^)]*\)\n\(.*\)$@sha512sums=\1 \2@;
  tbegin;
  P;
  D
' -i PKGBUILD
summen="$(makepkg -g)"
sed 's|sha512sums=.*$|'"${summen}"'|' -i PKGBUILD

rm -rf pkg src
sudo pacman -Sy
makepkg -fcsr || exit 1
git commit PKGBUILD -m "${paket} ${pkgver} -> ${remVer}"

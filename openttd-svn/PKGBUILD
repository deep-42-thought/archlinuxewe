# Maintainer: Erich Eckner <arch at eckner dot net>
pkgname=openttd-svn
pkgver=27534
pkgrel=1
pkgdesc="A FOSS clone of Transport Tycoon Deluxe."
arch=('x86_64')
url="http://www.openttd.org"
license=('')
groups=()
depends=(
    'sdl'
    'libpng'
    'fontconfig'
    'lzo'
)
makedepends=()
checkdepends=()
optdepends=()
provides=()
conflicts=()
replaces=()
backup=()
options=()
gfxversion=0.5.2
sfxversion=0.2.3
msxversion=0.3.1
source=(
    "http://binaries.openttd.org/extra/opengfx/$gfxversion/opengfx-$gfxversion-all.zip"
    "http://binaries.openttd.org/extra/opensfx/$sfxversion/opensfx-$sfxversion-all.zip"
    "http://binaries.openttd.org/extra/openmsx/$msxversion/openmsx-$msxversion-all.zip"
    "everything.patch"
    "clipboard.grf"
)
sha256sums=('19be61f1cb04cbb3cb9602f0b8eb6e6f56ecbefbfdd6e0e03f9579e5a5c1cbc8'
            '6831b651b3dc8b494026f7277989a1d757961b67c17b75d3c2e097451f75af02'
            '92e293ae89f13ad679f43185e83fb81fb8cad47fe63f4af3d3d9f955130460f5'
            '87c17a36bbc0f401e3aad88402e68cbc5ff743c728e403e5492879c931f08757'
            '12b90fe53f2d61d2d45d74ecc6b97d3a5f041c4215a5c1b02a6b1ba162e4572a')

package() {

    tar -xf opengfx-$gfxversion.tar

    git clone "https://git.openttd.org/trunk.git" $pkgname

    cd $pkgname
    git checkout 76fc2426669d3a52d392ab6838ebf30326294589

    patch -p1 < $srcdir/everything.patch

    ./configure --prefix-dir=/usr \
                --binary-dir=bin \
                --data-dir=share/openttd \
                --icon-dir=share/openttd \
                --man-dir=share/man \
                --personal-dir=.openttd \
                --install-dir=$pkgdir \

    make
    make DESTDIR=$pkgdir install

    # Install OpenGFX
    install -d $pkgdir/usr/share/openttd/data/opengfx-$gfxversion
    install -m 644 $srcdir/opengfx-$gfxversion/* $pkgdir/usr/share/openttd/data/opengfx-$gfxversion
    chown -R root:root $pkgdir/usr/share/openttd/data/opengfx-$gfxversion

    # Install OpenSFX
    install -d $pkgdir/usr/share/openttd/data/opensfx-$sfxversion
    install -m 644 $srcdir/opensfx-$sfxversion/* $pkgdir/usr/share/openttd/data/opensfx-$sfxversion
    chown -R root:root $pkgdir/usr/share/openttd/data/opensfx-$sfxversion

    # Install OpenMSX
    install -d $pkgdir/usr/share/openttd/gm
    install -m 644 $srcdir/openmsx-$msxversion/* $pkgdir/usr/share/openttd/gm
    chown -R root:root $pkgdir/usr/share/openttd/gm/*
    install -m644 $srcdir/clipboard.grf $pkgdir/usr/share/openttd/baseset/

    # Remove unnecessary languages
    cp $pkgdir/usr/share/openttd/lang/{english,german}.lng $srcdir
    rm $pkgdir/usr/share/openttd/lang/*
    install -m 644 $srcdir/{english,german}.lng $pkgdir/usr/share/openttd/lang

    # Remove junk
    rm -rf $pkgdir/usr/share/doc
    rm -rf $pkgdir/usr/share/openttd/scripts
    rm $pkgdir/usr/share/openttd/data/opengfx-$gfxversion/{changelog,readme}.txt
    rm $pkgdir/usr/share/openttd/data/opensfx-$sfxversion/{changelog,readme}.txt
    rm $pkgdir/usr/share/openttd/gm/{changelog,readme}.txt

}

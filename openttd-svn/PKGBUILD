# Maintainer: Erich Eckner <arch at eckner dot net>
pkgname=openttd-svn
pkgver=27547
pkgrel=1
pkgdesc="A FOSS clone of Transport Tycoon Deluxe."
arch=('x86_64' 'i686')
url="http://www.openttd.org"
license=('GPL2')
groups=()
depends=(
    'sdl'
    'xz'
    'icu'
    'fontconfig'
    'lzo'
)
makedepends=('subversion')
checkdepends=()
optdepends=(
    'openttd-opengfx: free graphics'
    'openttd-opensfx: free soundset'
    'openttd-openmsx: free music'
)
provides=('openttd')
conflicts=('openttd')
replaces=()
backup=()
options=()
source=(
    "everything.patch"
    "version.patch"
    "clipboard.grf"
)
sha256sums=('ef8545afbf3d7b036cb7d347aacdead521d063f477d0561124763804ad78596a'
            '69a604a37db76337a2709a0e63f5ca09b325af294225c42f4b7faf43c93ecc4c'
            '12b90fe53f2d61d2d45d74ecc6b97d3a5f041c4215a5c1b02a6b1ba162e4572a')

prepare() {

    svn export "svn://svn.openttd.org/trunk@r${pkgver}" trunk
    cd trunk

    cat $srcdir/everything.patch | \
      (
        read zeile
        while read zeile
        do
          [[ "${zeile}" == "diff --git a/"* ]] && break
        done
        echo "${zeile}"
        cat
      ) | \
      patch -p1

    patch -p2 < $srcdir/version.patch

}

build() {

    cd trunk
    ./configure ${_targetHost} \
		--prefix-dir=/usr \
                --binary-dir=bin \
                --data-dir=share/openttd \
                --icon-dir=share/openttd \
                --man-dir=share/man \
                --personal-dir=.openttd \
                --install-dir=$pkgdir \
    make

}

package() {

    cd trunk
    make DESTDIR=$pkgdir install
    install -m644 $srcdir/clipboard.grf $pkgdir/usr/share/openttd/baseset/

    # Remove unnecessary languages
    cp $pkgdir/usr/share/openttd/lang/{english,german}.lng $srcdir
    rm $pkgdir/usr/share/openttd/lang/*
    install -m 644 $srcdir/{english,german}.lng $pkgdir/usr/share/openttd/lang

    # Remove junk
    rm -rf $pkgdir/usr/share/doc
    rm -rf $pkgdir/usr/share/openttd/scripts

}
